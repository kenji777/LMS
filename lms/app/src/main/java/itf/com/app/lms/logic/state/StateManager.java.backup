package itf.com.app.lms.logic.state;

import android.os.Handler;
import android.os.Looper;
import android.util.Log;

import java.util.concurrent.atomic.AtomicReference;

/**
 * Centralized state management. Skeleton implementation.
 */
public class StateManager {
    private static final String TAG = "StateManager";

    private final AtomicReference<TestState> state = new AtomicReference<>(TestState.IDLE);
    private final TestProgress progress = new TestProgress();
    private final StateListener listener;
    private final Handler mainHandler = new Handler(Looper.getMainLooper());

    public StateManager(StateListener listener) {
        this.listener = listener;
    }

    public boolean transitionTo(TestState newState) {
        TestState old = state.get();
        if (!isValidTransition(old, newState)) {
            Log.w(TAG, "Invalid state transition: " + old + " -> " + newState);
            return false;
        }
        state.set(newState);
        notifyStateChanged(old, newState);
        return true;
    }

    public TestState getCurrentState() {
        return state.get();
    }

    public boolean isInState(TestState s) {
        return state.get() == s;
    }

    public void startTestSession(String serialNo, String modelId, int totalTests) {
        progress.reset();
        progress.setSerialNo(serialNo);
        progress.setModelId(modelId);
        progress.setTotalTests(totalTests);
        progress.setStartTimeMs(System.currentTimeMillis());
        transitionTo(TestState.INITIALIZING);
    }

    public void startTestItem(String testItemCode) {
        progress.setCurrentTestItem(testItemCode);
        notifyTestItemStarted(testItemCode);
    }

    public void completeTestItem(String testItemCode, boolean passed, String message) {
        progress.incrementCompletedTests();
        if (passed) {
            progress.incrementOkCount();
        } else {
            progress.incrementNgCount();
        }
        notifyTestItemCompleted(testItemCode, passed);
    }

    public void endTestSession() {
        progress.setEndTimeMs(System.currentTimeMillis());
        transitionTo(TestState.COMPLETED);
        notifyProgressUpdated();
    }

    public TestProgress getProgress() {
        return progress;
    }

    public void reset() {
        state.set(TestState.IDLE);
        progress.reset();
    }

    private void notifyStateChanged(TestState oldState, TestState newState) {
        if (listener != null) {
            mainHandler.post(() -> listener.onStateChanged(oldState, newState));
        }
    }

    private void notifyProgressUpdated() {
        if (listener != null) {
            mainHandler.post(() -> listener.onProgressUpdated(progress));
        }
    }

    private void notifyTestItemStarted(String code) {
        if (listener != null) {
            mainHandler.post(() -> listener.onTestItemStarted(code));
        }
    }

    private void notifyTestItemCompleted(String code, boolean passed) {
        if (listener != null) {
            mainHandler.post(() -> listener.onTestItemCompleted(code, passed));
        }
    }

    private boolean isValidTransition(TestState from, TestState to) {
        switch (from) {
            case IDLE:
                return to == TestState.INITIALIZING;
            case INITIALIZING:
                return to == TestState.READY || to == TestState.ERROR;
            case READY:
                return to == TestState.BARCODE_SCANNING || to == TestState.TESTING || to == TestState.ERROR;
            case TESTING:
                return to == TestState.EVALUATING || to == TestState.TIMEOUT || to == TestState.ERROR;
            case EVALUATING:
                return to == TestState.COMPLETED || to == TestState.FAILED || to == TestState.ERROR;
            default:
                return true;
        }
    }

    public interface StateListener {
        void onStateChanged(TestState oldState, TestState newState);

        void onProgressUpdated(TestProgress progress);

        void onTestItemStarted(String testItemCode);

        void onTestItemCompleted(String testItemCode, boolean passed);

        void onError(StateError error, String message);
    }

    public enum StateError {
        INVALID_TRANSITION,
        UNKNOWN
    }
}










